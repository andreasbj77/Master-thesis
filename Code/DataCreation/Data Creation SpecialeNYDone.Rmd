---
title: "Datacreation"
author: "Andreas Borup Joergensen, Mette Koch Moeller, Robert Hoestrup"
date: "04-06-2021"
output:
  html_notebook:
    code_folding: show
    df_print: paged
    theme: flatly
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
### Generic preamble
rm(list=ls())
Sys.setenv(LANG = "en")
options(scipen = 5)

library(knitr)
knitr::opts_chunk$set(warning=FALSE,
                     message=FALSE,
                     comment=FALSE, 
                     fig.align="center"
                     )
```

Downloading the required packages
```{r}
library(tidyverse) #Collection of all the good stuff like dplyr, ggplot2 ect.
library(magrittr) #For advanced piping
library(keras) #For deep learning models
library(tidymodels) 
library(tidyquant) # For getting stock data
library(ggpubr) #package that helps mixing multiple plots on the same page
library(Quandl) #For getting oilprices
library(rtweet) #For saving the data set as csv file
```

# Preprocessing the stocks
## Downloading the data
The data chosen for this study is the Danish C25 stock index. The daily stock price is downloaded directly from yahoo finance using the *tidyquant* package. Since we want to forecast the year of 2019, data selection and model creation is based on 2018. Therefore we need to download the stocks which were a part of the C25 index in 2018. What stocks to include is found in the following [link (Slide 7)](https://www.pwc.dk/da/arrangementer/2018/baggrundsmateriale-c25-by-numbers.pdf?fbclid=IwAR3mB8skoTQ8BuTjcMXuoef4vkWU5lMUNSqsvehZJRNr5zMpRkNTCnX34lU). All of the stock prices is in DKK. The time period examined is 2010-2019. Since we need enough data to train the model, we exclude stocks which is not listed on the Copenhagen stock exchange for the entire time period. These stocks include Chr. Hansen, ISS, Pandora, Ã˜rsted, Nets, and TDC.

```{r}
maera = c("MAERSK-A.CO") 
MaerskA <- tq_get(maera,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

maerb = c("MAERSK-B.CO") 
MaerskB <- tq_get(maerb,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

bav = c("BAVA.CO") 
Baverian <- tq_get(bav,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

car = c("CARL-B.CO") 
Carlsberg <- tq_get(car,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

col = c("COLO-B.CO") 
Coloplast <- tq_get(col,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

dan = c("DANSKE.CO") 
DanskeBank <- tq_get(dan,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

dsv = c("DSV.CO") 
DSV <- tq_get(dsv,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

fls = c("FLS.CO") 
FLSmidth <- tq_get(fls,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

gmab = c("GMAB.CO") 
Genmab <- tq_get(gmab,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

gn = c("GN.CO") 
GN <- tq_get(gn,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

lun = c("LUN.CO") 
Lundbeck <- tq_get(lun,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

lun = c("LUN.CO") 
Lundbeck <- tq_get(lun,
               from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

jys = c("JYSK.CO") 
JyskeBank <- tq_get(jys,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

nkt = c("NKT.CO") 
NKT <- tq_get(nkt,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

nor = c("NDA-DK.CO") 
Nordea <- tq_get(nor,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

novo = c("NOVO-B.CO") 
NovoNordisk <- tq_get(novo,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

novoz = c("NZYM-B.CO") 
Novozymes  <- tq_get(novoz,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

tryg = c("TRYG.CO") 
Tryg  <- tq_get(tryg,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

ves = c("VWS.CO") 
Vestas <- tq_get(ves,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")

wil = c("DEMANT.CO") 
WilliamDemant <- tq_get(wil,
                from = "2010-01-01",
               to = "2019-12-30",
               get = "stock.prices")
```

Cleaning the environment from unnecessary data sets.
```{r}
rm(bav, car, col, vol, dan, dsv, fls, gmab, gn, jys, lun, maera, maerb, nkt, nor, novo, novoz, tryg, ves, wil)
```

When using the *tidyquant* package, it downloads eight different variables, including the date, opening and closing price, and volume. For this study, it is chosen to forecast the closing price. Therefore the closing price and date are selected for each data set. To make it easier to manage when joining the data sets, the closing price is renamed the stock's name. Furthermore, the prices are rounded to 2 decimals. 

```{r}
MaerskA %<>%
  mutate(MaerskA = close %>% round(2))  %>%
  select(date, MaerskA) 

MaerskB %<>%
  mutate(MaerskB = close %>% round(2))  %>%
  select(date, MaerskB) 

Baverian %<>%
  mutate(Baverian = close %>% round(2))  %>%
  select(date, Baverian) 

Carlsberg %<>%
  mutate(Carlsberg = close %>% round(2))  %>%
  select(date,Carlsberg )  

Coloplast  %<>%
  mutate(Coloplast = close %>% round(2))  %>%
  select(date, Coloplast) 

DanskeBank %<>%
  mutate(DanskeBank = close %>% round(2))  %>%
  select(date, DanskeBank) 

DSV %<>%
  mutate(DSV = close %>% round(2))  %>%
  select(date, DSV) 

FLSmidth %<>%
  mutate(FLSmidth = close %>% round(2))  %>%
  select(date, FLSmidth) 

Genmab %<>%
  mutate(Genmab = close %>% round(2))  %>%
  select(date, Genmab) 
 
GN %<>%
  mutate(GN = close %>% round(2))  %>%
  select(date, GN) 

JyskeBank %<>%
  mutate(JyskeBank = close %>% round(2))  %>%
  select(date, JyskeBank) 

Lundbeck %<>%
  mutate(Lundbeck = close %>% round(2))  %>%
  select(date, Lundbeck) 
  
NKT %<>%
  mutate(NKT = close %>% round(2))  %>%
  select(date, NKT) 
 
Nordea %<>%
  mutate(Nordea  = close %>% round(2))  %>%
  select(date, Nordea ) 

NovoNordisk %<>%
  mutate(NovoNordisk = close %>% round(2))  %>%
  select(date, NovoNordisk) 

Novozymes %<>%
  mutate(Novozymes  = close %>% round(2))  %>%
  select(date, Novozymes) 

Tryg %<>%
  mutate(Tryg  = close %>% round(2))  %>%
  select(date, Tryg ) 
  

Vestas %<>%
  mutate(Vestas = close %>% round(2))  %>%
  select(date, Vestas) 
  

WilliamDemant %<>%
  mutate(WilliamDemant = close %>% round(2))  %>%
  select(date, WilliamDemant)
```
## Combing the data sets
The data set is left joined by the dates and combined into one data set named *data*. 
```{r}
data <- left_join(MaerskA, MaerskB, by = "date")
data <- left_join(data, Baverian, by = "date")
data <- left_join(data, Carlsberg, by = "date")
data <- left_join(data, Coloplast, by = "date")
data <- left_join(data, DanskeBank, by = "date")
data <- left_join(data, DSV, by = "date")
data <- left_join(data, FLSmidth, by = "date")
data <- left_join(data, Genmab, by = "date")
data <- left_join(data, GN, by = "date")
data <- left_join(data, JyskeBank, by = "date")
data <- left_join(data, Lundbeck, by = "date")
data <- left_join(data, NKT, by = "date")
data <- left_join(data, Nordea, by = "date")
data <- left_join(data, NovoNordisk, by = "date")
data <- left_join(data, Novozymes, by = "date")
data <- left_join(data, Tryg, by = "date")
data <- left_join(data, Vestas, by = "date")
data <- left_join(data, WilliamDemant, by = "date")
```
Renaming date to start with a capital letter
```{r}
data %<>% rename("Date" = "date")
```
Cleaning the environment from unnecessary data sets.
```{r}
rm(MaerskA, MaerskB, Baverian, Carlsberg, Coloplast, DanskeBank, DSV, FLSmidth, Genmab, GN, JyskeBank, Lundbeck, NKT, Nordea, NovoNordisk, Novozymes, Tryg, Vestas, WilliamDemant)
```

# Adding other feautures
## Oil price 
Other features besides the stocks are downloaded. The first feature is the oil price. The oil prices from West Texas Intermediate (WTI) is chosen for this study. The oil price is downloaded using the package *Quandl* 
```{r}
oil_daily <- Quandl("FRED/DCOILWTICO", 
                    type = "raw", 
                    collapse = "daily",  
                    from = "2010-01-01",
                    to = "2019-12-30") 
```   
The name for the oil price is changed from Value to OilPrice to make it easier to code. 
```{r}
oil_daily %<>%
  rename("OilPrice" = "Value")
```

The oil price is in American dollars. It is converted from USD to DKK since the remaining stocks are in DKK. Therefore the exchange rate from USD to DKK is downloaded as well. The exchange rate can be used as an additional feature. The exhange rate from yahoo finance has some missing data (some weeks in September 2019). Therefore the exchange rate is instead downloaded from investing.com and uploaded on Github.
```{r}
Currency <- read_tsv("https://raw.githubusercontent.com/andreasbj77/Master-thesis/main/Data/Currency.txt") %>% select(-X7)
Currency %<>% mutate(USD = USD/100, GBP = GBP/100, NOK = NOK/100, SEK = SEK/100, CNY = CNY/100)  %>%
  mutate(Date = Date %>% parse_date_time(orders = "dmy")) %>%
  mutate(Date = Date %>% as_date())
```

Left joining the oil price and the exchange rate by the date.  
```{r}
oil_daily %<>% 
  left_join(Currency, by = "Date")
```

The Oil price is converted from USD to DKK and rounded to 2 decimals. The exchange rate is removed oil data. 
```{r}
oil_daily %<>%
  mutate(OilPrice = (USD*OilPrice) %>% round(2)) %>%
  select(Date, OilPrice)
```

The oil price is now left joined to the data set.
```{r}
data <- left_join(data, oil_daily,  by =  "Date")
```

Cleaning the environment from unnecessary data sets.
```{r}
rm(oil_daily)
```

## Exchange rate
### USD/DKK
The USD/DKK exhange rate was downloaded earlier for converting the oil price. The exchange rate is left joined to the data set.
```{r}
data <- left_join(data, Currency,  by = "Date")
```
Rounding the exchange rate.
```{r}
data %<>%
  mutate(USD = USD %>% round(2), GBP = GBP %>% round(2), SEK = SEK %>% round(2), NOK = NOK %>% round(2), CNY = CNY %>% round(2))
```
Cleaning the environment from unnecessary data sets.
```{r}
rm(Currency)
```


# Bonds

## Two year danish state bond

```{r}
Two_year_Bond <- read_csv("https://raw.githubusercontent.com/andreasbj77/Master-thesis/main/Data/Denmark%202-Year%20Bond%20Yield%20Historical%20Data.csv") %>% select(Date, Price) %>% rename(Two_year_bond = Price)
```

```{r}
Two_year_Bond %<>% 
  mutate(Date = Date %>% parse_date_time(orders = "mdy")) %>%
  mutate(Date = Date %>% as_date()) %>%
  mutate(Two_year_bond = Two_year_bond %>% round(2)) %>%
  arrange(Date)
```

```{r}
data <- left_join(data, Two_year_Bond,  by = "Date")
```

```{r}
rm(Two_year_Bond)
```

## Ten year danish state bond
```{r}
Ten_year_Bond <- read_csv("https://raw.githubusercontent.com/andreasbj77/Master-thesis/main/Data/Denmark-10-Year-Bond-Yield-Historical-Data.csv") %>% select(Date, Price) %>% rename(Ten_year_bond = Price)
```

```{r}
Ten_year_Bond %<>% 
  mutate(Date = Date %>% parse_date_time(orders = "mdy")) %>%
  mutate(Date = Date %>% as_date()) %>%
  mutate(Ten_year_bond = Ten_year_bond %>% round(2)) %>%
  arrange(Date)
```

```{r}
data <- left_join(data, Ten_year_Bond,  by = "Date")
```

```{r}
rm(Ten_year_Bond)
```

# Gold

```{r}
Gold_futures <- read_csv("https://raw.githubusercontent.com/andreasbj77/Master-thesis/main/Data/Gold%20Futures%20Historical%20Data.csv") %>% select(Date, Price) %>% rename(Gold_futures = Price)
```

```{r}
Gold_futures %<>% 
  mutate(Date = Date %>% parse_date_time(orders = "mdy")) %>%
  mutate(Date = Date %>% as_date()) %>%
  mutate(Gold_futures = Gold_futures %>% round(2)) %>%
  arrange(Date)
```

```{r}
data <- left_join(data, Gold_futures,  by = "Date")
```

```{r}
rm(Gold_futures)
```


# C20 index

```{r}
C20_index <- read_csv("https://raw.githubusercontent.com/andreasbj77/Master-thesis/main/Data/OMX%20Copenhagen%2020%20Historical%20Data.csv") %>% select(Date, Price) %>% rename(C20_index = Price)
```

```{r}
C20_index %<>% 
  mutate(Date = Date %>% parse_date_time(orders = "mdy")) %>%
  mutate(Date = Date %>% as_date()) %>%
  mutate(C20_index = C20_index %>% round(2)) %>%
  arrange(Date)
```

```{r}
data <- left_join(data, C20_index,  by = "Date")
```

```{r}
rm(C20_index)
```


# Summary
Taking a look at the final data set
```{r}
data %>% glimpse()
```
# Saving the data set
The data set is now done and ready for EDA. It is saved as a cvs-file and uploaded on [Github](https://github.com/andreasbj77/Master-thesis?fbclid=IwAR1-uXAsXOvRxWwDzpfhzjiqyOhil9E4wklrK03_fRMZhLQ7EYTrooHzTw0)
```{r}
write_as_csv(data,"DataCreation.csv")
```






